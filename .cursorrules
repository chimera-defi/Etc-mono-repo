# AI Assistant Rules

> **Applies to:** All AI assistants (Cursor, Claude Code, GPT-4, Gemini, etc.)
>
> **Project docs:** `CLAUDE.md` (Claude Code), `wallets/AGENTS.md` (wallets), `mobile_experiments/Valdi/AGENTS.md` (Valdi), `staking/AGENTS.md` (staking), `ideas/AGENTS.md` (ideas)

---

## Token Efficiency (CRITICAL - AUTO-ACTIVE)

**Enforcement:** Hooks in `.claude/settings.json` + these rules (always on)
**Analysis:** `/token-reduce [file|dir]` skill (on-demand)

**Default behavior (enforced via rules + hooks):**
- Answer directly, keep reasoning implicit
- No restating context/rules/prompts
- Diffs over full files
- Lists ≤5 items unless expansion requested
- `[uses tool]` instead of narrating actions
- ~100 tokens for simple answers, ~200 for diffs, ~300 for summaries

- Cap tool output to ~120 lines; use `head/tail/sed` for longer content
- Avoid re-reading the same file in a session unless it changed
- Prefer `rg -g` scoped searches over broad directory scans

**Expand only when user says:** "Go deeper", "Expand", "Show reasoning", "Explore tradeoffs"

**Session workflow (automatic):**
1. Use QMD BM25 to find relevant files first (`qmd search "topic" -n 5 --files`)
2. Use targeted file reads (head/tail, not full files)
3. Parallel tool calls when possible
4. Skip preambles and confirmations
5. Prefer `rg --files -g` for structure scans before directory_tree

**Token reduction tools:**
- **QMD BM25 search** (recommended): `qmd search "topic" -n 5 --files` — 99% fewer tokens than naive reads
- **MCP CLI** (Cursor only, not Claude Code): See `.cursor/MCP_CLI.md` — adds 117% overhead in Claude Code
- **Benchmarked savings:** 89% (concise), 99% (QMD search vs naive), 33% (targeted reads)
- Complete guide: `.cursor/TOKEN_REDUCTION.md`

**Sub-agent delegation (prevents context compaction):**
- **>5 files to read?** → `Task(subagent_type="Explore")`
- **Uncertain where info lives?** → `Task(subagent_type="Explore")`
- **Pattern match across codebase?** → `Task(subagent_type="Explore")`
- **Complex multi-step research?** → `Task(subagent_type="general-purpose")`
- Sub-agents return summaries, keeping main context lean

---

## PR Attribution (Enforced)

**Required for all PRs:**
1. **Description:** `**Agent:** [Model Name]` (e.g., Claude Opus 4.5, not Claude Code)
2. **Commits:** Include `[Agent: ModelName]`
3. **Title:** Describe what's done, not the prompt
4. **Include:** Original prompt in `## Original Request`

**Template:**
```markdown
**Agent:** Claude Opus 4.5

## Summary
Brief description.

## Original Request
> [User's prompt]

## Changes Made
- Change 1
```

**Enforcement:** Git hook warns, CI validates, PR template auto-fills.

---

## Project Structure

- Artifacts: `.cursor/artifacts/`
- Keep projects in respective folders
- Never litter root with generated files

---

## Code Guidelines

- Prefer editing existing files over creating new ones
- Check for existing implementations before creating new
- Document assumptions in code comments
- Verify builds/lint/tests before completing
- No security vulnerabilities (OWASP top 10)
- Batch shell commands when possible to reduce tool calls
- Use `rg -g` to scope searches; if `rg` unavailable, fallback to `git grep`

---

## Framework Quick Reference

### Valdi
- Cross-platform: iOS, Android, macOS (NOT React/web)
- TSX compiles to native, lowercase tags (`<view>`, `<label>`)
- Class-based components with `onRender()` method
- CLI: `valdi dev_setup`, `valdi install ios`, `valdi hotreload`

### Flutter
- Scaffold: `flutter create --org com.org --project-name name`
- Verify: `flutter analyze`, `flutter test`
- Always `flutter pub get` after pubspec changes

### React Native
- Scaffold: `npx @react-native-community/cli init AppName --template @react-native-community/template`
- Verify: `npm run lint`, `npx tsc --noEmit`, `npm test`

---

## Meta Learnings (Condensed)

### Data Work
- **No data loss:** Verify ALL columns preserved on restructure (git diff)
- **Chains ≠ tokens:** Count blockchain networks, not tokens
- **When uncertain, be vague:** "Multi-chain" not "5500+ chains"
- **Line-by-line verify:** Check every cell before finalizing

### Code Work
- **Runability > syntax:** Code that can't run is worse than no code
- **Multi-tool verify:** Run ALL checks (lint, types, tests, build)
- **Scaffold before coding:** Use framework CLI first

### Documentation
- **Add, don't remove:** Consolidate means organize, not delete
- **Concise ≠ shorter:** Remove redundancy, not information
- **Single source of truth:** One table per data type

### PRs & Reviews
- **Model attribution:** Specific model (Claude Opus 4.5), not platform (Cursor)
- **Math verification:** Breakdown values must sum to stated totals
- **Cross-document consistency:** Data in multiple places must match
- **No direct pushes to main:** Always use a PR branch
- **Hooks required:** `git config core.hooksPath .githooks`
- **Rebase discipline:** Pull latest `main` and rebase at the start of each new request
- **One task = one PR:** Stack commits on a single branch/PR for the request
- **Branch/worktree first:** Create a feature branch/worktree before making changes
- **Always commit:** Self-authored commit messages with model attribution
- **Preserve research context:** Store sources in `.cursor/artifacts/` or project artifacts
- **Pricing verification:** Use provider sites for any pricing data; exclude free categories from merchant feeds

---

## Numbered Rules Reference

Rules are organized by domain. Reference by number in code reviews.

### Verification & Quality (1-30)
- **#11** Verify project structure against framework requirements
- **#19** Never trust without verification - cite sources or record experiments
- **#20** Think about runability - code must actually execute
- **#24** Multi-tool verification before declaring complete

### Data Integrity (31-54)
- **#31** Add columns, don't remove rows
- **#32** Never consolidate by deletion
- **#46** No data loss on restructure - verify ALL columns preserved
- **#47** Chains ≠ tokens (blockchain networks, not assets)
- **#52** When uncertain, be vague not specific
- **#53** Line-by-line verification before finalizing tables

### SEO & Web (65-71)
- **#66** SEO consistency across pages
- **#68** Cache-busting version parameter for OG images
- **#70** Regenerate OG images when adding pages

### Financial (72-81)
- **#72** Calculate token price from primary fundraising data
- **#78** Show calculation methodology, not just numbers
- **#82** Verify math in financial slides

### Documentation (92-98)
- **#93** Mark outdated docs clearly with ⚠️
- **#95** Preserve all information when consolidating

### Smart Contracts (108-115)
- **#108** Integration point comments are NOT implementation
- **#110** Noir: use `|` not `||`, `&` not `&&`
- **#111** Aztec needs `aztec-nargo`, standard Noir uses `nargo`

### PR Attribution (116-134)
- **#116** Always include model name in PRs
- **#117** Include model name in commit messages
- **#118** PR titles focus on what's done, not the prompt
- **#119** Include original prompt in PR description
- **#120** Create `.cursor/artifacts/` prompt file for complex requests
- **#121** PR structure: Agent → Summary → Original Request → Changes → Testing
- **#122** Include `Co-authored-by: Name <email>` in BOTH commit messages AND PR descriptions (CI validates PR description)
- **#124** Commit Co-authored-by goes in commit message body; PR Co-authored-by goes in PR description (both required)
- **#125** Meta learning: Co-authored-by in commit ≠ Co-authored-by in PR (need both for CI to pass)
- **#129** CI checks must not skip - all checks enforced
- **#134** Model attribution, not platform attribution

### Git Discipline (135-139)
- **#135** Never push directly to `main` or `master`
- **#136** Use a feature branch + PR for all changes
- **#137** Install hooks: `git config core.hooksPath .githooks`
- **#138** One task = one PR; keep all related commits in the same PR branch
- **#139** Create a branch/worktree before making changes

### Token Efficiency (140-157)
- **#140** Use QMD BM25 search before reading files (skip embed/vector — too slow)
- **#142** MCP CLI is for Cursor only; Claude Code native tools are faster (benchmarked 77-256x)
- **#148** Token reduction skill always active (see .cursor/TOKEN_REDUCTION.md and /token-reduce)
- **#149** Benchmarked token savings: 89% (concise), 99% (QMD search vs naive), 33% (targeted reads)
- **#151** Use sub-agents for exploration (>5 files, uncertain locations, pattern matching)
- **#152** Sub-agents return summaries - keeps main context lean, prevents compaction
- **#153** Hooks enforce: Read >300 lines blocked, Grep content warned, Glob >50 files warned

### Comparison Tables (123-139)
- **#123** Always include clickable website links
- **#127** Navigation consistency - add to ALL nav locations
- **#128** OG images for new comparison types
- **#130** Complete integration checklist for new types (see wallets/CONTRIBUTING.md)
- **#131** Status type mapping - create explicit mapping for different enums
- **#132** Structured data - update schema.org for new types
- **#133** Keyword detection - add SEO keywords for new comparison types
- **#135** Every column should be filterable

### Web Frontend (158-164)
- **#158** Update architecture docs immediately
- **#159** Check for dead code in state management
- **#161** Multi-pass code review before commit

---

## Wallets Project Specifics

**Core criteria (MUST HAVE):** Mobile app + Browser extension + Developer-friendly + Stable

**Scoring priorities:**
1. Platform coverage (mobile + extension)
2. Developer experience (tx simulation, testnets, custom RPC)
3. Stability (low release frequency = good)
4. Activity & open source

**Data sources:** GitHub (primary), official docs, WalletBeat, app stores

**Key files:** `SOFTWARE_WALLETS.md`, `HARDWARE_WALLETS.md`, `CRYPTO_CARDS.md`

See `wallets/AGENTS.md` for detailed methodology.

---

## Staking Project Specifics

**Focus:** Security-first, privacy-focused staking with Aztec/Noir

**Noir patterns:**
- Use `|` for OR, `&` for AND (not `||` and `&&`)
- Cross-contract calls need `FunctionSelector::from_signature()`
- AuthWit required for token transfers
- Extract pure math into testable modules

See `staking/AGENTS.md` for detailed patterns.

---

## Ideas Project Specifics

**Current projects:** Voice Coding Assistant (Cadence), Birthday Bot

**Focus:** Document exploration, prototype fast, store research

See `ideas/AGENTS.md` for project details.

