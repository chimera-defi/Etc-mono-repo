name: Security Validation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  security-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up environment
      run: |
        # Make scripts executable
        chmod +x *.sh
        chmod +x lib/*.sh
        chmod +x install/**/*.sh
        chmod +x docs/*.sh
        
    - name: Run security validation script
      run: |
        echo "Running security validation script..."
        
        if [ -f "docs/validate_security_safe.sh" ]; then
          echo "✅ Security validation script found"
          # Note: We don't run the full script as it requires root privileges
          # But we can validate its structure
          if [ -x "docs/validate_security_safe.sh" ]; then
            echo "✅ Security validation script is executable"
          else
            echo "⚠️  Security validation script is not executable"
          fi
        else
          echo "❌ Security validation script not found"
          exit 1
        fi
        
    - name: Check security configuration files
      run: |
        echo "Checking security configuration files..."
        
        # Check for SSH config
        if [ -f "configs/sshd_config" ]; then
          echo "✅ SSH config file exists"
          
          # Check for secure SSH settings
          if grep -q "PermitRootLogin" configs/sshd_config; then
            echo "✅ SSH config has PermitRootLogin setting"
          else
            echo "⚠️  SSH config missing PermitRootLogin setting"
          fi
          
          if grep -q "PasswordAuthentication" configs/sshd_config; then
            echo "✅ SSH config has PasswordAuthentication setting"
          else
            echo "⚠️  SSH config missing PasswordAuthentication setting"
          fi
        else
          echo "❌ SSH config file missing"
          exit 1
        fi
        
        # Check for consolidated security script (includes firewall setup)
        if [ -f "install/security/consolidated_security.sh" ]; then
          echo "✅ Consolidated security script exists (includes firewall)"
        else
          echo "❌ Consolidated security script missing"
          exit 1
        fi
        
        # Check for nginx hardening script
        if [ -f "install/security/nginx_harden.sh" ]; then
          echo "✅ Nginx hardening script exists"
        else
          echo "❌ Nginx hardening script missing"
        fi
        
    - name: Validate network security configurations
      run: |
        echo "Validating network security configurations..."
        
        # Check that all client configs bind to localhost only
        echo "Checking client configurations for localhost binding..."
        
        # Check execution client configs
        for client_dir in configs/*/; do
          if [ -d "$client_dir" ]; then
            client_name=$(basename "$client_dir")
            echo "Checking $client_name configurations..."
            
            # Look for any 0.0.0.0 bindings (should be avoided)
            if find "$client_dir" -name "*.yaml" -o -name "*.toml" -o -name "*.cfg" -o -name "*.json" | xargs grep -l "0\.0\.0\.0" 2>/dev/null; then
              echo "⚠️  Found 0.0.0.0 bindings in $client_name configs"
            else
              echo "✅ No 0.0.0.0 bindings in $client_name configs"
            fi
            
            # Look for localhost bindings (good)
            if find "$client_dir" -name "*.yaml" -o -name "*.toml" -o -name "*.cfg" -o -name "*.json" | xargs grep -l "127\.0\.0\.1\|localhost" 2>/dev/null; then
              echo "✅ Found localhost bindings in $client_name configs"
            else
              echo "⚠️  No localhost bindings found in $client_name configs"
            fi
          fi
        done
        
    - name: Check for security anti-patterns
      run: |
        echo "Checking for security anti-patterns..."
        
        # Check for hardcoded credentials or sensitive data
        echo "Checking for potential hardcoded credentials..."
        if grep -r -i "password\|secret\|key\|token" --include="*.sh" . | grep -v "echo" | grep -v "log_" | head -5; then
          echo "⚠️  Found potential hardcoded credentials (first 5 matches shown)"
        else
          echo "✅ No obvious hardcoded credentials found"
        fi
        
        # Check for proper file permissions in scripts
        echo "Checking file permissions..."
        find . -name "*.sh" -type f | while read -r script; do
          perms=$(stat -c "%a" "$script" 2>/dev/null || stat -f "%A" "$script" 2>/dev/null)
          if [ "$perms" = "755" ] || [ "$perms" = "744" ]; then
            echo "✅ $script has appropriate permissions ($perms)"
          else
            echo "⚠️  $script has unusual permissions ($perms)"
          fi
        done
        
    - name: Validate input sanitization
      run: |
        echo "Validating input sanitization..."
        
        # Check for input validation functions
        if grep -q "validate_user_input" lib/common_functions.sh; then
          echo "✅ Input validation function exists"
        else
          echo "⚠️  Input validation function not found"
        fi
        
        if grep -q "validate_menu_choice" lib/common_functions.sh; then
          echo "✅ Menu choice validation function exists"
        else
          echo "⚠️  Menu choice validation function not found"
        fi
        
        # Check for usage of validation functions
        validation_usage=$(grep -r "validate_user_input\|validate_menu_choice" --include="*.sh" . | wc -l)
        echo "✅ Found $validation_usage usages of validation functions"
        
    - name: Check security documentation
      run: |
        echo "Checking security documentation..."
        
        # Check for security-related documentation
        security_docs=$(find docs -name "*security*" -o -name "*SECURITY*" | wc -l)
        echo "✅ Found $security_docs security-related documentation files"
        
        # Check for security testing scripts
        if [ -f "install/security/test_security_fixes.sh" ]; then
          echo "✅ Security testing script exists"
        else
          echo "❌ Security testing script missing"
          exit 1
        fi
        
        # Check for security validation scripts
        security_scripts=$(find docs -name "*security*" -name "*.sh" | wc -l)
        echo "✅ Found $security_scripts security validation scripts"
        
    - name: Summary
      run: |
        echo "=== Security Validation Summary ==="
        echo "✅ Security validation script structure checked"
        echo "✅ Security configuration files validated"
        echo "✅ Network security configurations checked"
        echo "✅ Security anti-patterns checked"
        echo "✅ Input sanitization validated"
        echo "✅ Security documentation checked"
        echo ""
        echo "Security validation completed!"
