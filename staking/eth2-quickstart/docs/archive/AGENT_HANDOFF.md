# Agent Handoff: Eth2 Quick Start Upgrade

## Overview
This document outlines the plan and implementation to transform "Eth2 Quick Start" from a collection of scripts into a cohesive, product-like experience (The "Flywheel").

---

## ⚠️ CRITICAL SECURITY REQUIREMENTS ⚠️

**READ THIS FIRST - DO NOT SKIP**

This project handles **real money** (ETH validators). Security is paramount.

### The Two-Phase Security Model

Installation MUST happen in TWO separate phases with a MANDATORY REBOOT between them:

| Phase | User | Script | Purpose |
|-------|------|--------|---------|
| **Phase 1** | root | `run_1.sh` / `install_phase1.sh` | System hardening, SSH config, new user creation |
| **REBOOT** | - | `sudo reboot` | **MANDATORY** - Security changes require reboot |
| **Phase 2** | new user | `run_2.sh` / `install_phase2.sh` | Ethereum client installation |

### Why This Matters

1. **SSH Hardening**: Phase 1 changes SSH port and disables root login. User MUST verify they can login with new credentials before proceeding.

2. **Privilege Separation**: Phase 1 runs as root for system changes. Phase 2 runs as the new non-root user for application installation.

3. **Security Verification**: The reboot ensures all security changes (firewall, intrusion detection, SSH) are properly applied.

4. **No Rollback Point**: Once Phase 2 starts, the user has committed to the new security model. The reboot forces them to verify access first.

### NEVER Do This

```bash
# ❌ WRONG - Running both phases in one script
./run_1.sh && ./run_2.sh  # DANGEROUS - skips reboot and verification

# ❌ WRONG - Single manifest that chains everything
./install_manifest.sh  # If this runs both phases, it's BROKEN
```

### Always Do This

```bash
# ✅ CORRECT - Two separate phases with reboot
sudo ./install_phase1.sh   # As root
sudo reboot                # MANDATORY
# SSH back in as new user
./install_phase2.sh        # As new user (NOT root)
```

---

## Lessons Learned (Add to this section!)

### 2025-12-28: Two-Phase Model Regression

**Problem**: Initial flywheel implementation generated a single `install_manifest.sh` that ran `run_1.sh` followed immediately by client installation. This BROKE the security model.

**Root Cause**: The reference implementation in this document was flawed - it didn't account for the required reboot between phases.

**Fix**: Configure.sh now generates TWO scripts:
- `install_phase1.sh` - Runs run_1.sh, then STOPS and requires reboot
- `install_phase2.sh` - Runs client installation, refuses to run as root

**Lesson**: Always check existing `run_1.sh` and `run_2.sh` to understand the security flow before creating new installation methods.

### 2025-12-28: Port Checking Fallback

**Problem**: The `ss` command may not be available on all systems, causing doctor.sh to fail.

**Fix**: Implemented fallback chain: `ss` → `netstat` → `/proc/net/tcp`

**Lesson**: Always provide fallbacks for system utilities that may not be universally available.

### 2025-12-28: Code Reuse via common_functions.sh

**Problem**: Initial implementation duplicated color definitions and logging functions across multiple scripts.

**Fix**: All scripts now source `lib/common_functions.sh` for colors and logging, except for bootstrap scripts that run before the repo is cloned.

**Lesson**: Always use `lib/common_functions.sh` instead of duplicating code. For bootstrap scripts, define minimal colors locally, then source common_functions.sh after cloning.

---

## Implementation Details

### Core Components

| Component | Location | Purpose |
|-----------|----------|---------|
| `install.sh` | Root | Bootstrap entry point for `curl \| bash` |
| `configure.sh` | `install/utils/` | Interactive TUI wizard |
| `run_manifest.sh` | `install/utils/` | Phase-aware execution runner |
| `doctor.sh` | `install/utils/` | Health verification script |
| `install_phase1.sh` | Root (generated) | Phase 1: System hardening |
| `install_phase2.sh` | Root (generated) | Phase 2: Client installation |

### Configuration Files

| File | Purpose |
|------|---------|
| `exports.sh` | Base configuration (all variables) |
| `config/user_config.env` | User overrides (generated by wizard) |
| `config/user_config.env.example` | Example configuration |

### The Strategy

We moved from manual configuration (`nano exports.sh`) to an automated "One-Liner" experience (`curl | bash`).

**Before:**
1. Clone repo
2. Manually edit exports.sh
3. Run run_1.sh
4. Reboot
5. Run run_2.sh

**After:**
1. `curl -fsSL .../install.sh | sudo bash`
2. Interactive wizard configures everything
3. Run generated install_phase1.sh
4. Reboot
5. Run generated install_phase2.sh

---

## Pre-Implementation Checklist

Before implementing any changes to the installation flow:

- [ ] Read `run_1.sh` completely - understand what it does
- [ ] Read `run_2.sh` completely - understand what it does
- [ ] Verify Phase 1 runs as root
- [ ] Verify Phase 2 runs as non-root user
- [ ] Confirm reboot is MANDATORY between phases
- [ ] Test that Phase 2 refuses to run as root
- [ ] Test that Phase 1 credentials work after reboot
- [ ] Source `lib/common_functions.sh` instead of duplicating code

---

## Testing Checklist

- [ ] ShellCheck passes on all scripts
- [ ] Bash syntax validation passes (`bash -n`)
- [ ] Scripts source common_functions.sh correctly
- [ ] Phase scripts are generated by configure.sh
- [ ] Phase 1 requires root
- [ ] Phase 2 refuses root
- [ ] Doctor.sh health checks work
- [ ] Port checking has fallbacks
- [ ] User configuration is respected

---

## Reference: File Changes Summary

### New Files
- `install.sh` - Bootstrap entry point
- `install/utils/configure.sh` - TUI wizard
- `install/utils/doctor.sh` - Health checks
- `install/utils/run_manifest.sh` - Phase runner
- `config/.gitkeep` - Config directory
- `config/user_config.env.example` - Example config
- `progress.md` - Development tracking

### Modified Files
- `exports.sh` - Added user config override block
- `.cursorrules` - Added two-phase security model docs
- `docs/AGENT_HANDOFF.md` - This file (rewritten)

### Generated Files (by configure.sh)
- `install_phase1.sh` - Phase 1 script
- `install_phase2.sh` - Phase 2 script
- `config/user_config.env` - User configuration
