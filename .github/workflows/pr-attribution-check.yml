name: PR Attribution Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-pr-attribution:
    name: Check PR Attribution
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            const title = pr.title || '';
            const body = pr.body || '';
            
            const errors = [];
            const warnings = [];
            
            // Check for agent attribution
            // Matches: **Agent:** [name] or Agent: [name] where name is one of the known agents
            const agentPattern = /\*\*Agent:\s*\*\*.*|Agent:\s*(Composer|Claude|GPT|Gemini|Cursor|Opus|AI Assistant)/i;
            // Also check for the format **Agent:** [name] at the start of the body
            const hasAgentAttribution = agentPattern.test(body) || /^\*\*Agent:\s*/.test(body.trim());
            if (!hasAgentAttribution) {
              errors.push('❌ PR description missing agent attribution. Add `**Agent:** [Agent Name]` at the top. Valid agents: Composer, Claude Code, GPT-4, Gemini, Claude Opus, Cursor AI');
            }
            
            // Check for original request
            const originalRequestPattern = /##\s*Original\s*Request|Original\s*Request/i;
            if (!originalRequestPattern.test(body)) {
              warnings.push('⚠️ PR description missing "## Original Request" section. Consider adding the original prompt.');
            }
            
            // Check PR title quality (should describe what was done, not the prompt)
            const badTitlePatterns = [
              /user\s+asked/i,
              /as\s+requested/i,
              /implement\s+.*\s+as\s+requested/i,
              /add\s+.*\s+as\s+requested/i
            ];
            
            let hasBadTitle = false;
            for (const pattern of badTitlePatterns) {
              if (pattern.test(title)) {
                hasBadTitle = true;
                break;
              }
            }
            
            if (hasBadTitle) {
              warnings.push('⚠️ PR title appears to reference the prompt rather than describing what was done. Consider: "Add X" instead of "User asked to add X".');
            }
            
            // Output results
            if (errors.length > 0 || warnings.length > 0) {
              let comment = '## PR Attribution Check\n\n';
              
              if (errors.length > 0) {
                comment += '### ❌ Required Fixes\n';
                errors.forEach(err => comment += `- ${err}\n`);
                comment += '\n';
              }
              
              if (warnings.length > 0) {
                comment += '### ⚠️ Suggestions\n';
                warnings.forEach(warn => comment += `- ${warn}\n`);
                comment += '\n';
              }
              
              comment += 'See [.cursorrules](/.cursorrules) "PR Attribution Requirements" section for the required format.\n';
              comment += '\n';
              comment += '**Note:** This check does not block merging, but following these guidelines helps track agent usage and performance.';
              
              // Post as PR comment
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              // Exit with error if required fixes are missing
              if (errors.length > 0) {
                core.setFailed('PR attribution check failed. See PR comment for details.');
              }
            } else {
              console.log('✅ PR attribution check passed!');
            }
