name: PR Attribution Check

on:
  pull_request:
    types: [opened, edited, synchronize]
    # Run on all PRs - attribution is important for all changes
    # Paths filter removed to ensure attribution checks run on all PRs

jobs:
  check-pr-attribution:
    name: Check PR Attribution
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            // core is already provided by actions/github-script@v7
            const pr = context.payload.pull_request;
            const title = pr.title || '';
            const body = pr.body || '';
            
            const errors = [];
            const warnings = [];
            
            // Check for agent attribution
            // Matches: **Agent:** [name] at the start of PR body
            // Example: **Agent:** Claude Sonnet 4.5
            const agentPattern = /^\*\*Agent:\*\*\s+.+/i;
            const hasAgentAttribution = agentPattern.test(body.trim());
            if (!hasAgentAttribution) {
              errors.push('❌ PR description missing agent attribution. Add `**Agent:** [Model Name]` at the top (e.g., Claude Sonnet 4.5, Claude Opus 4.5, GPT-4o)');
            }

            // Check for Co-authored-by attribution (required per .cursorrules Rule #122)
            // Matches: **Co-authored-by:** Name <email> or Co-authored-by: Name <email>
            // Example: **Co-authored-by:** Chimera <chimera_defi@protonmail.com>
            const coauthorPattern = /^\*\*Co-authored-by:\*\*\s+.+<.+@.+>/im;
            const hasCoauthor = coauthorPattern.test(body);
            if (!hasCoauthor) {
              errors.push('❌ PR description missing co-author attribution. Add `**Co-authored-by:** Name <email>` (e.g., **Co-authored-by:** Chimera <chimera_defi@protonmail.com>)');
            }

            // Check for original request (required per .cursorrules Rule #119)
            const originalRequestPattern = /##\s*Original\s*Request/i;
            if (!originalRequestPattern.test(body)) {
              errors.push('❌ PR description missing "## Original Request" section. Add the original user prompt.');
            }
            
            // Check PR title quality (should describe what was done, not the prompt)
            const badTitlePatterns = [
              /user\s+asked/i,
              /as\s+requested/i,
              /implement\s+.*\s+as\s+requested/i,
              /add\s+.*\s+as\s+requested/i
            ];
            
            let hasBadTitle = false;
            for (const pattern of badTitlePatterns) {
              if (pattern.test(title)) {
                hasBadTitle = true;
                break;
              }
            }
            
            if (hasBadTitle) {
              warnings.push('⚠️ PR title appears to reference the prompt rather than describing what was done. Consider: "Add X" instead of "User asked to add X".');
            }
            
            // Output results
            if (errors.length > 0 || warnings.length > 0) {
              let comment = '## PR Attribution Check\n\n';
              
              if (errors.length > 0) {
                comment += '### ❌ Required Fixes\n';
                errors.forEach(err => comment += `- ${err}\n`);
                comment += '\n';
              }
              
              if (warnings.length > 0) {
                comment += '### ⚠️ Suggestions\n';
                warnings.forEach(warn => comment += `- ${warn}\n`);
                comment += '\n';
              }
              
              comment += 'See [.cursorrules](/.cursorrules) "PR Attribution Requirements" section for the required format.\n';
              comment += '\n';
              if (errors.length > 0) {
                comment += '**This check will fail the PR until required fixes are addressed.**';
              } else {
                comment += '**Suggestions above are optional but recommended for better tracking.**';
              }
              
              // Post as PR comment
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              // Exit with error if required fixes are missing
              if (errors.length > 0) {
                core.setFailed('PR attribution check failed. See PR comment for details.');
              }
            } else {
              console.log('✅ PR attribution check passed!');
            }
