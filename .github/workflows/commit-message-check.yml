name: Commit Message Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

concurrency:
  group: commit-message-check-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  check-commit-messages:
    name: Check Commit Messages
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Validate commit messages in PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              { owner, repo, pull_number, per_page: 100 }
            );

            const headerPattern = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)\([a-z0-9._/-]+\): [^\s].* \[Agent: .+\]$/;
            const trailerLinePattern = /^[A-Za-z0-9-]+:\s+.+$/;
            const bypassPattern = /^(Merge |Revert |fixup! |squash! )/;
            const errors = [];

            function getTrailingTrailers(message) {
              const lines = message.split('\n');
              let index = lines.length - 1;
              while (index >= 0 && lines[index].trim() === '') {
                index -= 1;
              }

              const trailers = [];
              while (index >= 0 && trailerLinePattern.test(lines[index])) {
                trailers.push(lines[index]);
                index -= 1;
              }

              return trailers.reverse();
            }

            for (const item of commits) {
              const message = item.commit.message || '';
              const [header = ''] = message.split('\n');

              if (bypassPattern.test(header)) {
                continue;
              }

              if (!headerPattern.test(header)) {
                errors.push(`- ${item.sha.slice(0, 7)}: invalid header \`${header}\``);
                continue;
              }

              const trailers = getTrailingTrailers(message);
              const hasCoAuthoredByTrailer = trailers.some((line) =>
                /^Co-authored-by: .+ <.+@.+>$/.test(line)
              );
              if (!hasCoAuthoredByTrailer) {
                errors.push(
                  `- ${item.sha.slice(0, 7)}: missing required trailing \`Co-authored-by:\` trailer`
                );
              }
            }

            if (errors.length > 0) {
              core.setFailed(
                [
                  'Commit message validation failed.',
                  '',
                  'Required format:',
                  '  type(scope): subject [Agent: <MODEL NAME>]',
                  '',
                  'Required trailer:',
                  '  Co-authored-by: <MODEL NAME> <model@vendor.invalid>',
                  '',
                  'Violations:',
                  ...errors
                ].join('\n')
              );
            } else {
              core.info(`Validated ${commits.length} commit message(s).`);
            }
