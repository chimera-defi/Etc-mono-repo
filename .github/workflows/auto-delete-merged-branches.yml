# Auto-Delete Merged Branches Workflow
#
# This workflow automatically deletes branches that have been merged into the main branch.
# It runs daily and cleans up merged branches across the entire repository.
#
# Schedule: Daily at 2:00 AM UTC
# Manual: Can also be triggered manually via workflow_dispatch

name: Auto-Delete Merged Branches

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be deleted without actually deleting)'
        required: false
        default: 'false'
        type: boolean
      target_branch:
        description: 'Target branch to check merges against (default: main)'
        required: false
        default: 'main'
        type: string

permissions:
  contents: write

jobs:
  delete-merged-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to check merge status
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Set target branch
        id: set_target
        run: |
          TARGET_BRANCH="${{ github.event.inputs.target_branch || 'main' }}"
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          echo "Using target branch: ${TARGET_BRANCH}"
      
      - name: Fetch all branches
        run: |
          git fetch --all --prune
      
      - name: Find merged branches
        id: find_merged
        run: |
          TARGET_BRANCH="${{ steps.set_target.outputs.target_branch }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          # Get list of merged branches (excluding main/master, HEAD, and protected branches)
          MERGED_BRANCHES=$(git branch -r --merged origin/${TARGET_BRANCH} | \
            grep -v "origin/${TARGET_BRANCH}" | \
            grep -v "origin/HEAD" | \
            grep -v "origin/main" | \
            grep -v "origin/master" | \
            sed 's/origin\///' | \
            xargs -r)
          
          # Filter out protected branches (add more patterns as needed)
          PROTECTED_PATTERNS="main master develop staging production"
          FILTERED_BRANCHES=""
          
          for branch in $MERGED_BRANCHES; do
            IS_PROTECTED=false
            for protected in $PROTECTED_PATTERNS; do
              if [ "$branch" = "$protected" ]; then
                IS_PROTECTED=true
                break
              fi
            done
            
            if [ "$IS_PROTECTED" = "false" ]; then
              FILTERED_BRANCHES="$FILTERED_BRANCHES $branch"
            fi
          done
          
          # Trim whitespace
          FILTERED_BRANCHES=$(echo $FILTERED_BRANCHES | xargs)
          
          if [ -z "$FILTERED_BRANCHES" ]; then
            echo "No merged branches found to delete"
            echo "branches=" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "Found merged branches: $FILTERED_BRANCHES"
            echo "branches=$FILTERED_BRANCHES" >> $GITHUB_OUTPUT
            echo "count=$(echo $FILTERED_BRANCHES | wc -w)" >> $GITHUB_OUTPUT
            
            # Show what would be deleted
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Merged Branches Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for branch in $FILTERED_BRANCHES; do
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done
          fi
      
      - name: Delete merged branches
        if: steps.find_merged.outputs.count != '0' && github.event.inputs.dry_run != 'true'
        run: |
          TARGET_BRANCH="${{ steps.set_target.outputs.target_branch }}"
          BRANCHES="${{ steps.find_merged.outputs.branches }}"
          
          DELETED_COUNT=0
          FAILED_COUNT=0
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deletion Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for branch in $BRANCHES; do
            echo "Attempting to delete branch: $branch"
            
            # Try to delete the branch
            if git push origin --delete "$branch" 2>&1; then
              echo "✅ Successfully deleted: \`$branch\`" >> $GITHUB_STEP_SUMMARY
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "❌ Failed to delete: \`$branch\`" >> $GITHUB_STEP_SUMMARY
              FAILED_COUNT=$((FAILED_COUNT + 1))
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $DELETED_COUNT deleted, $FAILED_COUNT failed" >> $GITHUB_STEP_SUMMARY
      
      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true' && steps.find_merged.outputs.count != '0'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Dry Run Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ No branches were actually deleted. Run without \`dry_run\` to delete these branches." >> $GITHUB_STEP_SUMMARY
      
      - name: No branches to delete
        if: steps.find_merged.outputs.count == '0'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## No Merged Branches Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All branches are up to date. No merged branches to delete." >> $GITHUB_STEP_SUMMARY
